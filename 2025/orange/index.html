<!DOCTYPE html>
<html lang="en-us">

<head>
  <meta charset="utf-8">
  <meta name="generator" content="Hugo 0.148.2">

  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="author" content="">
  <meta property="og:url" content="https://nagarajrpoojari.github.io/opennotes/2025/orange/">

  <title>Introducing OrangeDB: A Distributed Key-Doc Database - opennotes</title>
  <meta property="og:title" content="Introducing OrangeDB: A Distributed Key-Doc Database - opennotes">
  <meta property="og:type" content="article">
  
  
  
  <meta property="og:description" content="OrangeDB is a key-document distributed database built on top of Parrot, an LSM-based storage engine. Learn how OrangeDB combines ideas from MongoDB and Cassandra for a powerful new system.">
  <meta name="description" content="OrangeDB is a key-document distributed database built on top of Parrot, an LSM-based storage engine. Learn how OrangeDB combines ideas from MongoDB and Cassandra for a powerful new system.">
  

  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Code+Pro|Arvo:400,700">
  <link rel="stylesheet" href="/opennotes/css/highlight.css">
  <link rel="stylesheet" href="/opennotes/css/journal.css">
  <link href="/opennotes/index.xml" rel="alternate" type="application/rss+xml" title="opennotes">

</head>

<body>
  <div class="container">

    <div class="site-header-nav">
    <nav class="site-nav">
      <a href="https://nagarajrpoojari.github.io/opennotes/">Index</a>
    </nav>
    <div>
    
      <span><a href="/opennotes/about">About</a></span>
    
      <span><a href="/opennotes/now">Now</a></span>
    
    </div>
    </div>
    


  <article class="post">
    <header class="post-header">
      <h1 class="post-title">Introducing OrangeDB: A Distributed Key-Doc Database</h1>
      <time class="post-date" datetime="2025-08-16 11:11:09 IST">16 Aug 2025</time>
    </header>

    <p>A couple of months ago, I started building a small LSM tree-based storage engine, which I call <strong>Parrot</strong>.</p>
<p>If you&rsquo;re unfamiliar with LSM trees—unlike B-trees, which require frequent reorganizations—LSM (Log-Structured Merge) trees write data as sequential logs. One of the main problems with B/B+ trees is <strong>write amplification</strong>. Inserting a single row might trigger multiple rearrangements across various index trees, leading to costly <strong>random disk writes</strong>, especially in persistent systems.</p>
<p>LSM trees avoid this by leveraging <strong>sequential writes</strong>, making write operations extremely fast. But there’s a tradeoff—<strong>read performance</strong>. Since records are spread across multiple levels, a read operation might need to scan through several files until it finds the desired record.</p>
<p><em>Read more about LSM <a href="https://en.wikipedia.org/wiki/Log-structured_merge-tree">here</a></em>.</p>
<hr>
<h2 id="what-makes-parrot-different">What Makes Parrot Different?</h2>
<p>Parrot isn’t just another LSM tree engine. It includes several optimizations aimed at speeding up I/O and improving concurrency.</p>
<ul>
<li>
<p><strong>Chain of Memtables</strong><br>
What happens to writes while flushing the memtable? Many systems use a double-buffered approach—write to one while flushing the other. But if the second also fills up before flushing completes, things get messy.<br>
Parrot uses a <strong>chain of memtables</strong>, where new memtables are continuously added to a queue. The flusher works independently, flushing from the other end of the queue, enabling uninterrupted writes.</p>
</li>
<li>
<p><strong>Optimistic Concurrency Control</strong><br>
Parrot minimizes locking, using optimistic strategies for concurrent writes and reads.</p>
</li>
<li>
<p><strong>Zero-Copy Reads</strong><br>
Parrot uses <strong>shared memory mapping (mmap)</strong> to read files. It avoids copying file data to user-space buffers; threads read directly from the kernel page cache, reducing latency and memory usage.</p>
</li>
</ul>
<div style="text-align: center;">
  <img src="/opennotes/images/2025/lsm2.png" alt="zero disk architecture" style="width: 100%;" />
</div>
<hr>
<h2 id="introducing-orangedb">Introducing <strong>OrangeDB</strong></h2>
<p><strong>Orange</strong> is a distributed key-document database built on top of Parrot. It provides:</p>
<ul>
<li>SQL-like interface via <strong>OQL</strong></li>
<li>Native JSON-like document encoding</li>
<li>Rich set of data types</li>
<li>Sharding and replication out of the box</li>
</ul>
<hr>
<h2 id="sharding-consistency-and-replication">Sharding, Consistency, and Replication</h2>
<p>OrangeDB combines the architectures of <strong>MongoDB</strong> and <strong>Cassandra</strong>, striking a balance between high availability and consistency.</p>
<p>An Orange cluster consists of three main components:</p>
<ul>
<li>
<p><strong>Router</strong><br>
Uses <strong>consistent hashing</strong> to route queries to the appropriate shard. It also supports a concept we call <em>&ldquo;consistent ring within a consistent ring&rdquo;</em> to map keys precisely to replicas.</p>
</li>
<li>
<p><strong>Shard</strong><br>
A group of replicas (or &ldquo;siblings&rdquo;) running OrangeDB instances. These replicas use a <strong>leaderless</strong> model—any replica that receives a write replicates it to others, similar to Cassandra’s gossip-style replication.</p>
</li>
<li>
<p><strong>Operator</strong><br>
A custom Kubernetes Operator for deploying and managing OrangeDB clusters.</p>
</li>
</ul>
<h4 id="read-consistency-levels">Read Consistency Levels</h4>
<p>OrangeDB supports configurable read strategies:</p>
<ul>
<li>
<p><strong>all</strong><br>
Queries <strong>all siblings</strong> of a shard and requires <strong>unanimous agreement</strong> on the value.<br>
If any replica is out of sync, the read fails.<br>
This mode provides <strong>strong consistency</strong>, but may have higher latency.</p>
</li>
<li>
<p><strong>quorum</strong><br>
Queries all siblings but only requires a <strong>majority to agree</strong> on the value.<br>
Offers a balance between consistency and availability.<br>
Can optionally trigger <strong>read repair</strong> to sync outdated replicas.</p>
</li>
<li>
<p><strong>single</strong><br>
Queries only the <strong>primary replica</strong> responsible for the key.<br>
This is the <strong>fastest</strong> mode but assumes the primary is <strong>alive and up-to-date</strong>.<br>
Suitable when you need <strong>strong consistency</strong> with <strong>low latency</strong>, but <em>primary node</em> is a <em>single point of failure</em>.</p>
</li>
</ul>
<h2 id="deployment-options">Deployment Options</h2>
<p>OrangeDB is available in multiple flavors.</p>
<h3 id="standalone-mode">Standalone Mode</h3>
<p>Run a single OrangeDB instance with gRPC endpoints. Use the Go client to send OQL or gRPC-based queries.</p>
<pre tabindex="0"><code>app % orange server --port 8000
  ___                             
 / _ \ _ __ __ _ _ __   __ _  ___ 
| | | | &#39;__/ _&#39; | &#39;_ \ / _&#39; |/ _ \
| |_| | | | (_| | | | | (_| |  __/
 \___/|_|  \__,_|_| |_|\__, |\___|
                       |___/      
Running project: `orange`
Starting server at 127.0.0.1:8000 
</code></pre><p>You can interact with it using the REPL:</p>
<pre tabindex="0"><code>app % orange repl --port 8000 --address localhost
# Welcome to orange
&gt; SELECT * FROM users WHERE _ID = 10
</code></pre><h3 id="sharded-cluster-on-kubernetes">Sharded Cluster on Kubernetes</h3>
<p>Step 1: Deploy OrangeDB Operator</p>
<pre tabindex="0"><code>kubectl apply -f https://raw.githubusercontent.com/nagarajRPoojari/orangectl/main/dist/install.yaml
</code></pre><p>Step 2: Define Orange Cluster</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span><span style="color:#75715e"># orange.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">ctl.orangectl.orange.db/v1alpha1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">OrangeCtl</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">orangectl-sample</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/name</span>: <span style="color:#ae81ff">orangectl</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/managed-by</span>: <span style="color:#ae81ff">kustomize</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">router</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">router</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">app</span>: <span style="color:#ae81ff">orange-router</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">tier</span>: <span style="color:#ae81ff">control</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">np137270/gateway:latest</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">port</span>: <span style="color:#ae81ff">8000</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">config</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">ROUTING_MODE</span>: <span style="color:#e6db74">&#34;hash&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">LOG_LEVEL</span>: <span style="color:#e6db74">&#34;info&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">shard</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">shard</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">app</span>: <span style="color:#ae81ff">orange-shard</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">tier</span>: <span style="color:#ae81ff">data</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">np137270/orange:latest</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">count</span>: <span style="color:#ae81ff">2</span>                <span style="color:#75715e"># Number of shards</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">2</span>             <span style="color:#75715e"># Replicas per shard</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">port</span>: <span style="color:#ae81ff">52001</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">config</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">STORAGE_PATH</span>: <span style="color:#e6db74">&#34;/app/data&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">CACHE_ENABLED</span>: <span style="color:#e6db74">&#34;true&#34;</span>
</span></span></code></pre></div><pre tabindex="0"><code>kubectl apply -f orange.yaml
kubectl port-forward svc/router 8000:8000
</code></pre><p>Step 3: Try Some Queries</p>
<pre tabindex="0"><code>echo &#34;Creating schema...&#34;
curl -X POST http://localhost:8000/  \
     -H &#34;Content-Type: application/json&#34; \
     -d &#39;{&#34;query&#34;: &#34;create document test {\&#34;name\&#34;:\&#34;STRING\&#34;}&#34;}&#39;

echo &#34;Inserting documents from ID 1 to 20...&#34;
for i in $(seq 1 20); do
  curl -s -X POST http://localhost:8000/ \
       -H &#34;Content-Type: application/json&#34; \
       -d &#34;{\&#34;query\&#34;: \&#34;insert value into test  {\\\&#34;_ID\\\&#34;: $i, \\\&#34;name\\\&#34;: \\\&#34;hello-$i\\\&#34;}\&#34;}&#34;
done

echo &#34;Searching for document with _ID = 13...&#34;
curl -X POST http://localhost:8000/  \
     -H &#34;Content-Type: application/json&#34; \
     -d &#39;{&#34;query&#34;: &#34;select * from test where _ID = 13&#34;}&#39;
</code></pre><h2 id="whats-next">What&rsquo;s Next?</h2>
<p>OrangeDB is still evolving. We&rsquo;re working on:</p>
<ul>
<li>Transaction support</li>
<li>Better indexing strategies</li>
<li>Integration with stream processing engines</li>
</ul>
<p>Feedback, contributions, and critiques are welcome.</p>


  </article>

<script async data-uid="0576bb9e32" src="https://avin.ck.page/0576bb9e32/index.js"></script>


      <footer class="site-footer">
        <div class="rc-scout" style="margin-right: auto; margin-top: auto; font-size: 0.6rem;"></div>
        <script async defer src="https://www.recurse-scout.com/loader.js?t=a4aabd5087bb19daf083302de1b46650"></script>

        <span class="person-schema" itemscope itemtype="http://schema.org/Person">
          <link itemprop="url" href="https://nagarajrpoojari.github.io/opennotes/">
          <span itemprop="name"></span>

          <br>

          <a itemprop="sameAs" href="https://github.com/avinassh" title="GitHub"><img src="/opennotes/svg/gh.svg" alt="icon name"></a>

          <a itemprop="sameAs" href="/opennotes/index.xml" title="GitHub"><img src="/opennotes/svg/rss.svg" alt="icon name"></a>

          

          
        </span>

        
      </footer>
    </div>

  <script src="/opennotes/js/highlight.pack.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>
  <script data-goatcounter="https://avi.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
  </body>
</html>

